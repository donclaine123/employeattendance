<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Department Head Dashboard - Workline</title>
    <link rel="stylesheet" href="../css/variable.css" />
    <link rel="stylesheet" href="../css/modal.css" />
    <link rel="stylesheet" href="../css/DepartmentHead.css" />
    <link rel="stylesheet" href="../css/profile.css" />
    <!-- Directory protection - must be first -->
    <script src="../js/directory-guard.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Top header with logo and logout -->
        <header class="top-header">
            <div class="logo">
                <div class="logo-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" fill="currentColor"/>
                        <path d="M8 12h8M12 8v8" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </div>
                <span class="logo-text">Workline</span>
            </div>
            <div class="header-actions">
                <button class="btn-icon" id="profileBtn" aria-label="View profile">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </button>
                <button class="btn-logout" id="logoutBtn">Logout</button>
            </div>
        </header>

        <!-- Main dashboard content -->
        <div class="dashboard-main">
            <!-- First main card with greeting, info, buttons, and tiles -->
            <div class="main-card">
                <div class="card-content">
                    <!-- Left side: greeting + employee info + buttons + status -->
                    <div class="left-section">
                        <div class="greeting-section">
                            <h1 class="greeting">Good morning,<br><strong id="userName">Loading...</strong></h1>
                            <p class="role" id="userRole">Loading...</p>
                        </div>

                        <div class="employee-card">
                            <div class="card-row">
                                <span class="label">Department</span>
                                <span class="value" id="userDepartment">Loading...</span>
                            </div>
                            <div class="card-row">
                                <span class="label">Date</span>
                                <span class="value" id="currentDate">Loading...</span>
                            </div>
                            <div class="card-row">
                                <span class="label">Scope</span>
                                <span class="value" id="userScope">Loading...</span>
                            </div>
                            <div class="card-row">
                                <span class="label">QR Attendance</span>
                                <span class="value" id="systemStatus">Checking...</span>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn-primary" id="download-report-btn">Download Team Report (PDF/Excel)</button>
                        </div>

                        <div class="status-notice">
                            <div>
                                <p>This dashboard displays real-time attendance for the Registrar department only. Use filters to narrow by date and status. Export anytime.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right side: help text + image tiles -->
                    <div class="right-section">
                        <div class="help-box">
                            <p>This dashboard displays relevant department KPIs and quick actions for heads. Use the filters to narrow results.</p>
                        </div>

                        <div class="image-tiles">
                            <div class="tile">
                                <div class="tile-img red-gradient"></div>
                                <span>Full screen for scan data</span>
                            </div>
                            <div class="tile">
                                <div class="tile-img orange-gradient"></div>
                                <span>Missing markers for shifts</span>
                            </div>
                            <div class="tile">
                                <div class="tile-img red-dots"></div>
                                <span>Mixed red for warnings</span>
                            </div>
                            <div class="tile">
                                <div class="tile-img dark-gradient"></div>
                                <span>Deep navy for headers</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Second row: two attendance cards side by side -->
            <div class="attendance-row">
                <div class="attendance-card-left">
                    <h3>Team Summary</h3>
                    <p class="subtitle">Snapshot of today's attendance for Registrar.</p>
                    <div class="stat-chips" style="margin-top:12px;">
                        <div class="stat-chip"><div class="num">0</div><div class="lbl">Total Present</div></div>
                        <div class="stat-chip"><div class="num">0</div><div class="lbl">Total Late</div></div>
                        <div class="stat-chip"><div class="num">0</div><div class="lbl">Total Absent</div></div>
                    </div>
                    <div style="margin-top:12px;display:flex;gap:8px;">
                        <button class="btn-secondary">Refresh Now</button>
                        <button class="btn-secondary">View monthly trends</button>
                    </div>
                </div>

                <div class="attendance-card-right">
                    <h3>Filters</h3>
                    <p class="subtitle">Refine your real-time view.</p>
                    <div class="filter-controls">
                        <div class="filter-group">
                            <label for="filter-date-start">Date Range</label>
                            <div class="date-inputs">
                                <input type="date" id="filter-date-start" name="filter-date-start">
                                <span>to</span>
                                <input type="date" id="filter-date-end" name="filter-date-end">
                            </div>
                        </div>
                        <div class="filter-group">
                            <label for="filter-employee">Employee</label>
                            <input type="text" id="filter-employee" name="filter-employee" placeholder="Search by name or ID">
                        </div>
                        <div class="filter-group">
                            <label for="filter-status">Status</label>
                            <select id="filter-status" name="filter-status">
                                <option value="">All</option>
                                <option value="present">Present</option>
                                <option value="late">Late</option>
                                <option value="absent">Absent</option>
                                <option value="leave">On Leave</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button class="btn-primary" id="apply-filters-btn">Apply Filters</button>
                        <button class="btn-secondary" id="clear-filters-btn">Clear Filters</button>
                    </div>
                </div>
            </div>

            <!-- Real-time Attendance wide card -->
            <div class="wide-card" style="margin-top: 8px;">
                <h3>Real-time Attendance</h3>
                <p class="subtitle">Live roster for Registrar â€” Name, ID, Time-in, Status.</p>
                <table class="attendance-table">
                    <thead>
                        <tr>
                            <th>Employee Name</th>
                            <th>ID</th>
                            <th>Time-in</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="attendance-empty-row">
                            <td colspan="4" style="text-align:center;color:var(--muted-foreground);padding:24px;">
                                No attendance records yet for the department. Use the live scanner or refresh to load attendance.
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="table-actions">
                    <button class="btn-secondary">Apply Filters</button>
                    <button class="btn-secondary">Load more</button>
                </div>
            </div>

            <!-- Leave & Overtime Approvals -->
            <div class="wide-card" style="margin-top: 8px;">
                <h3>Leave & Overtime Approvals</h3>
                <p class="subtitle">Review and act on pending requests from your team.</p>
                <table class="approval-table">
                    <thead>
                        <tr>
                            <th>Employee Name</th>
                            <th>Request Type</th>
                            <th>Dates</th>
                            <th>Reason</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="approval-empty-row">
                            <td colspan="5" class="approval-empty-state">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 12l2 2 4-4"></path>
                                    <circle cx="12" cy="12" r="10"></circle>
                                </svg>
                                No pending approvals at this time.
                            </td>
                        </tr>
                        <!-- Example Row -->
                        <tr>
                           <td><span class="employee-name">IT Employee</span></td>
                           <td><span class="request-type-badge leave">leave</span></td>
                           <td><span class="date-range">2025-09-22 to 2025-09-23</span></td>
                           <td><span class="request-reason">Family event</span></td>
                           <td>
                               <div class="approval-actions">
                                   <button class="btn-approve">
                                       <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                           <path d="M9 12l2 2 4-4"></path>
                                           <circle cx="12" cy="12" r="10"></circle>
                                       </svg>
                                       Approve
                                   </button>
                                   <button class="btn-decline">
                                       <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                           <circle cx="12" cy="12" r="10"></circle>
                                           <line x1="15" y1="9" x2="9" y2="15"></line>
                                           <line x1="9" y1="9" x2="15" y2="15"></line>
                                       </svg>
                                       Decline
                                   </button>
                               </div>
                           </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Footer -->
            <div class="dashboard-footer">
                <div class="footer-left">
                    <span>Having trouble? <a href="#">Contact IT Support: itsupport@scc.edu.ph</a></span>
                </div>
                <div class="footer-right">
                    <span>Auto-logout after 30 mins idle (warning at 10 mins)</span>
                </div>
            </div>
        </div>

        <!-- Hidden controls for navigation -->
        <div style="display: none;">
            <button id="backBtn">Back to portal</button>
        </div>
    </div>

    <!-- Employee Performance Modal -->
    <div id="performance-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-employee-name">Employee Performance</h3>
                <button id="modal-close-btn" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="performance-summary">
                    <div class="summary-item">
                        <span class="summary-label">Total Absences</span>
                        <span id="summary-absences" class="summary-value">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Total Lates</span>
                        <span id="summary-lates" class="summary-value">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Total Undertime (hours)</span>
                        <span id="summary-undertime" class="summary-value">0</span>
                    </div>
                </div>
                <h4>Attendance Trend</h4>
                <div id="performance-chart-container">
                    <!-- A chart could be rendered here -->
                    <p>Chart visualization coming soon.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/auth-guard.js"></script>
    <script>
        // Protect page - only department heads and superadmin can access
        const user = AuthGuard.protect(['head_dept']);
        if (!user) {
            // Page access denied, auth guard will handle redirect
            throw new Error('Access denied');
        }
    </script>
    <script src="../js/api.js"></script>
    <script src="../js/profile.js"></script>
    <script src="../js/departmenthead.js"></script>
    <script>
        // Session-aware UI: show signed-in email if present and load user profile
        (async function(){
            const userRaw = sessionStorage.getItem('workline_user');
            const token = sessionStorage.getItem('workline_token');
            
            if (!userRaw || !token) {
                // Redirect to login if no session
                window.location.href = '../index.html';
                return;
            }

            try {
                const user = JSON.parse(userRaw);
                
                // Load user profile from backend
                const response = await fetch(`${window.API_URL}/auth/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const profile = await response.json();
                    updateUserInterface(profile);
                } else {
                    // Fallback to session data if API fails
                    updateUserInterface(user);
                }
            } catch(e) {
                console.error('Error loading user profile:', e);
                // Fallback to basic display
                document.getElementById('userName').textContent = 'User';
                document.getElementById('userRole').textContent = 'Dashboard';
            }

            // Update current date
            updateCurrentDate();
            
            // Check system status
            checkSystemStatus();

            // Event handlers
            document.getElementById('backBtn').addEventListener('click', function(){ 
                window.location.href = '../index.html'; 
            });
            
            document.getElementById('logoutBtn').addEventListener('click', function(){ 
                AuthGuard.logout();
            });

            // Profile button handler
            document.getElementById('profileBtn').addEventListener('click', function() {
                const user = ProfileModal.getCurrentUser();
                ProfileModal.open('head_dept', user);
            });
        })();

        function updateUserInterface(profile) {
            // Update greeting based on time of day
            const hour = new Date().getHours();
            let greeting = 'Good evening';
            if (hour < 12) greeting = 'Good morning';
            else if (hour < 18) greeting = 'Good afternoon';
            
            // Update greeting and role
            const fullName = profile.first_name && profile.last_name ? 
                `${profile.first_name} ${profile.last_name}` : 
                profile.full_name || profile.username || 'User';
            
            document.getElementById('userName').textContent = fullName;
            
            // Update the greeting text
            document.querySelector('.greeting').innerHTML = `${greeting},<br><strong id="userName">${fullName}</strong>`;
            
            // Department Head specific role display
            const department = profile.department || 'Department';
            const roleDisplay = `Head of ${department} Department`;
            document.getElementById('userRole').textContent = roleDisplay;
            
            // Update department
            document.getElementById('userDepartment').textContent = department;
            
            // Update scope
            document.getElementById('userScope').textContent = `Showing only ${department} department`;
        }

        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: '2-digit' 
            };
            const dateString = now.toLocaleDateString('en-US', options);
            document.getElementById('currentDate').textContent = dateString;
        }

        async function checkSystemStatus() {
            try {
                const response = await fetch(`${window.API_URL.replace('/api', '')}/health`);
                if (response.ok) {
                    document.getElementById('systemStatus').textContent = 'Monitoring enabled';
                } else {
                    document.getElementById('systemStatus').textContent = 'System issues';
                }
            } catch (e) {
                document.getElementById('systemStatus').textContent = 'Connection error';
            }
        }
    </script>
    <script>
        // Toggle empty-state and notify departmenthead.js to refresh counts
        (function(){
            const table = document.querySelector('.wide-card .attendance-table') || document.querySelector('.attendance-table');
            if (!table) return;
            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            const emptyRow = document.getElementById('attendance-empty-row');

            function refreshEmpty(){
                const realRows = Array.from(tbody.children).filter(r => r.id !== 'attendance-empty-row');
                if (emptyRow) emptyRow.style.display = realRows.length ? 'none' : '';
                // call global updater if present
                if (window && typeof window.updateDepartmentChips === 'function') window.updateDepartmentChips();
                // departmenthead.js uses MutationObserver so it should pick up changes automatically
            }

            refreshEmpty();
            const mo = new MutationObserver(refreshEmpty);
            mo.observe(tbody, { childList: true });
        })();
    </script>
</body>
</html>
