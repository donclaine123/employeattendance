<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HR Dashboard - Workline</title>
    <link rel="stylesheet" href="../css/variable.css" />
    <link rel="stylesheet" href="../css/modal.css" />
    <link rel="stylesheet" href="../css/HRDashboard.css" />
    <link rel="stylesheet" href="../css/profile.css" />
    <!-- Directory protection - must be first -->
    <script src="../js/directory-guard.js"></script>
</head>
<body class="hr-page">
    <div class="dashboard-container">
        <!-- Top header with logo and logout -->
        <header class="top-header">
            <div class="logo">
                <div class="logo-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" fill="currentColor"/>
                        <path d="M8 12h8M12 8v8" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </div>
                <span class="logo-text">Workline</span>
            </div>
            <div class="header-actions">
                <button class="btn-icon" id="profileBtn" aria-label="View profile">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </button>
                <button class="btn-logout" id="logoutBtn">Logout</button>
            </div>
        </header>

        <!-- Main dashboard content -->
        <div class="dashboard-main">
            <!-- HR Nav Tabs -->
            <nav class="hr-tabs">
                <button class="tab active">Dashboard</button>
                <button class="tab">QR Codes</button>
                <button class="tab">Employees</button>
                <button class="tab">Invitations</button>
                <button class="tab">Departments</button>
                <button class="tab">Reports</button>
                <button class="tab">Override</button>
            </nav>
            <!-- First main card with greeting, info, buttons, and tiles -->
            <div class="main-card" id="dashboard-section">
                <div class="card-content">
                    <!-- Left side: greeting + employee info + buttons + status -->
                    <div class="left-section">
                        <div class="greeting-section">
                            <h1 class="greeting">Good morning,<br><strong id="userName">Loading...</strong></h1>
                            <p class="role" id="userRole">Loading...</p>
                        </div>

                        <div class="employee-card">
                            <div class="card-row">
                                <span class="label">Role</span>
                                <span class="value" id="userRoleDetail">Loading...</span>
                            </div>
                            <div class="card-row">
                                <span class="label">Date</span>
                                <span class="value" id="currentDate">Loading...</span>
                            </div>
                            <div class="card-row">
                                <span class="label">Scope</span>
                                <span class="value" id="userScope">Loading...</span>
                            </div>
                            <div class="card-row">
                                <span class="label">QR Attendance</span>
                                <span class="value" id="systemStatus">Checking...</span>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn-primary">Export Daily Report (PDF/Excel)</button>
                        </div>

                        <div class="status-notice">
                            <div>
                                <p>This dashboard displays real-time attendance for the Registrar department only. Use filters to narrow by date and status. Export anytime.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right side: help text + image tiles -->
                    <div class="right-section">
                        <div class="help-box">
                            <p>This dashboard displays relevant department KPIs and quick actions for heads. Use the filters to narrow results.</p>
                        </div>

                        <div class="image-tiles">
                            <div class="tile">
                                <div class="tile-img red-gradient"></div>
                                <span>Full screen for scan data</span>
                            </div>
                            <div class="tile">
                                <div class="tile-img orange-gradient"></div>
                                <span>Missing markers for shifts</span>
                            </div>
                            <div class="tile">
                                <div class="tile-img red-dots"></div>
                                <span>Mixed red for warnings</span>
                            </div>
                            <div class="tile">
                                <div class="tile-img dark-gradient"></div>
                                <span>Deep navy for headers</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- QR Codes main card (duplicate of main-card but contains Generate QR UI) -->
            <div class="main-card qr-main-card" id="qr-section" style="display: none;">
                <div class="card-content qr-card-content">
                    <!-- Left column: details and actions -->
                    <div class="qr-left">
                        <h3>Generate QR Code</h3>
                        <p>Create or revoke the daily QR for check-in</p>
                        <div class="qr-meta">
                            <div class="meta-row"><strong>Last Generated</strong><div id="qr-last" class="meta-value">—</div></div>
                            <div class="meta-row"><strong>Expires</strong><div id="qr-expires" class="meta-value">—</div></div>
                        </div>
                        <!-- QR controls: toggles for rotation, static backup, geofence -->
                        <div class="toggle-row">
                            <div id="toggle-rotation" class="toggle on" role="switch" aria-checked="true">
                                <div class="toggle-label">Rotation</div>
                                <div class="switch"><div class="knob"></div></div>
                            </div>

                            <div id="toggle-static" class="toggle off" role="switch" aria-checked="false">
                                <div class="toggle-label">Static</div>
                                <div class="switch"><div class="knob"></div></div>
                            </div>

                            <div id="toggle-geofence" class="toggle on" role="switch" aria-checked="true">
                                <div class="toggle-label">Geofence</div>
                                <div class="switch"><div class="knob"></div></div>
                            </div>
                        </div>
                        <div class="qr-actions">
                            <button id="generateQrBtn" class="btn-primary">Generate Daily QR Code</button>
                            <button id="revokeQrBtn" class="btn-secondary">Revoke Current QR</button>
                        </div>
                    </div>

                    <!-- Right column: bordered QR box / empty state -->
                    <div class="qr-preview">
                        <div id="qr-box">qr code</div>
                    </div>
                </div>
            </div>

            <!-- Second row: two cards -->
            <div class="attendance-row">
                <div class="attendance-card-left">
                    <h3>Dashboard Overview</h3>
                    <p class="subtitle">Snapshot of today's attendance for Registrar.</p>
                    <div class="stat-chips" style="margin-top:12px;">
                        <div class="stat-chip"><div class="num">12</div><div class="lbl">Total Present</div></div>
                        <div class="stat-chip"><div class="num">3</div><div class="lbl">Total Late</div></div>
                        <div class="stat-chip"><div class="num">1</div><div class="lbl">Total Absent</div></div>
                    </div>
                        <div class="filter-chips" style="margin-top:12px;">
                        <div class="filter-chip">Date: Apr 07, 2025</div>
                        <div class="filter-chip">Department: All</div>
                        <button id="hr-refresh-btn" class="btn-secondary">Refresh</button>
                    </div>
                </div>

                <div class="attendance-card-right">
                    <h3>Generate QR Code</h3>
                    <p class="subtitle">Create or revoke the daily QR for check-in.</p>
                    <div class="kv-pair"><span class="k">Last Generated</span><span class="v">7:45 AM</span></div>
                    <div class="kv-pair"><span class="k">Expires</span><span class="v">10:45 AM</span></div>
                    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
                        <button class="btn-primary">Generate Daily QR Code</button>
                        <button class="btn-secondary">Revoke Current QR</button>
                    </div>
                </div>
            </div>

            <!-- Manage Employees -->
            <div class="wide-card" style="margin-top: 8px; display: none;" id="employees-section">
                <h3>Manage Employees</h3>
                <p class="subtitle">Search, filter, and manage employee records.</p>
                
                <!-- Enhanced controls section -->
                <div class="employees-controls">
                    <div class="search-filter-row">
                        <input id="hr-search" type="search" placeholder="Search employees by name, ID or department" class="search-input" />
                        <select id="hr-dept" class="filter-select">
                            <option value="">All departments</option>
                        </select>
                        <button id="addEmployeeBtn" class="btn-primary">Add Employee</button>
                    </div>
                    
                    <!-- Bulk actions section -->
                    <div class="bulk-actions" id="bulkActions" style="display: none;">
                        <div class="bulk-actions-left">
                            <span class="selected-count" id="selectedCount">0 selected</span>
                        </div>
                        <div class="bulk-actions-right">
                            <button class="btn-bulk" id="bulkDeactivateBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M15 9l-6 6M9 9l6 6"></path>
                                </svg>
                                Deactivate
                            </button>
                            <button class="btn-bulk" id="bulkMoveDeptBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14,2 14,8 20,8"></polyline>
                                </svg>
                                Move Department
                            </button>
                            <button class="btn-bulk" id="bulkAssignRoleBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M22 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                Assign Role
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Enhanced table with new columns -->
                <div class="table-container">
                    <table class="employees-table">
                        <thead>
                            <tr>
                                <th class="checkbox-column">
                                    <input type="checkbox" id="selectAll" class="select-all-checkbox">
                                </th>
                                <th>Name</th>
                                <th>ID</th>
                                <th>Position</th>
                                <th>Email</th>
                                <th>Department</th>
                                <th>Hire Date</th>
                                <th>Last Login</th>
                                <th>Status</th>
                                <th class="actions-column">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="employeesTableBody">
                            <tr id="hr-empty-row">
                                <td colspan="10" style="text-align:center;color:var(--muted-foreground);padding:18px;">No employees yet. Use the <strong>Add Employee</strong> button to create records.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination controls -->
                <div class="table-footer">
                    <div class="pagination-info">
                        <span id="paginationInfo">Showing 1-10 of 0 employees</span>
                        <select id="rowsPerPage" class="rows-per-page">
                            <option value="10">10 per page</option>
                            <option value="25">25 per page</option>
                            <option value="50">50 per page</option>
                        </select>
                    </div>
                    <div class="pagination-controls">
                        <button class="btn-pagination" id="prevPage" disabled>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15,18 9,12 15,6"></polyline>
                            </svg>
                            Previous
                        </button>
                        <div class="page-numbers" id="pageNumbers"></div>
                        <button class="btn-pagination" id="nextPage" disabled>
                            Next
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9,18 15,12 9,6"></polyline>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Invitations Section -->
            <div class="wide-card" style="margin-top: 8px; display: none;" id="invitations-section">
                <div class="card-header">
                    <div>
                        <h3>Invitation Management</h3>
                        <p class="subtitle">Send invitations for new employee accounts</p>
                    </div>
                    <button class="btn-primary" onclick="window.hrInvitations.openCreateModal()">
                        <svg width="16" height="16" style="margin-right: 6px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                            <path d="M22 11h-4m2-2v4"></path>
                        </svg>
                        Invite Employee
                    </button>
                </div>

                <!-- Filter Controls -->
                <div class="filter-row" style="margin-bottom: 20px;">
                    <div class="filter-group">
                        <select id="roleFilter" onchange="window.hrInvitations.applyFilters()">
                            <option value="">All Roles</option>
                            <option value="employee">Employee</option>
                            <option value="department head">Department Head</option>
                            <option value="hr">HR</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <select id="departmentFilter" onchange="window.hrInvitations.applyFilters()">
                            <option value="">All Departments</option>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                    <div class="filter-group">
                        <button class="btn-secondary" onclick="window.hrInvitations.refreshInvitations()">
                            <svg width="16" height="16" style="margin-right: 4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                                <path d="M21 3v5h-5"></path>
                                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                                <path d="M3 21v-5h5"></path>
                            </svg>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Invitations Table -->
                <div class="table-container">
                    <table class="data-table" id="invitationsTable">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Department</th>
                                <th>Created</th>
                                <th>Expires</th>
                                <th>Created By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="invitationsTableBody">
                            <tr>
                                <td colspan="7" class="loading-row">
                                    <div class="spinner-small"></div>
                                    Loading invitations...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Empty State -->
                <div id="invitationsEmptyState" class="empty-state" style="display: none;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.5">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                        <path d="M22 11h-4m2-2v4"></path>
                    </svg>
                    <h4>No Pending Invitations</h4>
                    <p>Create your first invitation to get started</p>
                    <button class="btn-primary" onclick="window.hrInvitations.openCreateModal()">
                        Invite Employee
                    </button>
                </div>
            </div>

            <!-- Reports + Manual Override -->
            <div class="attendance-row" style="margin-top: 8px; display: none;" id="reports-section">
                <div class="attendance-card-left">
                    <h3>Reports</h3>
                    <p class="subtitle">Select a range and preview before export.</p>
                    <div class="filter-chips">
                        <div class="filter-chip">Date range: Apr 01 – Apr 07</div>
                        <div class="filter-chip">Department: All</div>
                    </div>
                    <div style="margin-top:12px;">
                        <button class="btn-primary">Export (PDF/Excel)</button>
                    </div>
                </div>

                <div class="attendance-card-right">
                    <h3>Manual Override</h3>
                    <p class="subtitle">Record an adjustment with a required reason. Logged to audit trail.</p>
                    <div class="filter-chips">
                        <div class="filter-chip">Employee ID</div>
                        <div class="filter-chip">Reason (required)</div>
                    </div>
                    <div class="kv-grid">
                        <div class="kv-pair"><span class="k">Time</span><span class="v">8:22 AM</span></div>
                        <div class="kv-pair"><span class="k">Action</span><span class="v">Override: EMP-0172 set Present</span></div>
                        <div class="kv-pair"><span class="k">By</span><span class="v">T. Rhodes</span></div>
                        <div class="kv-pair"><span class="k">Time</span><span class="v">8:05 AM</span></div>
                        <div class="kv-pair"><span class="k">Action</span><span class="v">Revoke QR issued</span></div>
                        <div class="kv-pair"><span class="k">By</span><span class="v">T. Rhodes</span></div>
                    </div>
                    <div style="margin-top:12px; display:flex; gap:10px;">
                        <button class="btn-primary">Save Override</button>
                        <button class="btn-secondary">Cancel</button>
                    </div>
                </div>
            </div>
            <!-- Real-time Attendance wide card -->
            <div class="wide-card" style="margin-top: 8px; display: none;" id="attendance-section">
                <h3>Real-time Attendance</h3>
                <p class="subtitle">Live roster for Registrar — Name, ID, Time-in, Status.</p>
                <table class="attendance-table">
                    <thead>
                        <tr>
                            <th>Employee Name</th>
                            <th>ID</th>
                            <th>Time-in</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dynamic content will be loaded here by JavaScript -->
                    </tbody>
                </table>
                <div class="table-actions">
                    <button class="btn-secondary">Apply Filters</button>
                    <button class="btn-secondary">Load more</button>
                </div>
            </div>

            <!-- Departments Management section -->
            <div class="wide-card" style="margin-top: 8px; display: none;" id="departments-section">
                <h3>Department Management</h3>
                <p class="subtitle">Assign department heads and manage department structure.</p>
                <table class="attendance-table" id="departments-table">
                    <thead>
                        <tr>
                            <th>Department</th>
                            <th>Description</th>
                            <th>Department Head</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dynamic content will be loaded here by JavaScript -->
                    </tbody>
                </table>
                <div class="table-actions">
                    <button class="btn-secondary" id="refreshDepartmentsBtn">Refresh</button>
                </div>
            </div>

            <!-- Footer -->
            <div class="dashboard-footer">
                <div class="footer-left">
                    <span>Clean, modern, and timeless. Need help? Contact HR Systems.</span>
                </div>
                <div class="footer-right">
                    <span>Auto-logout after 15 mins idle (warning at 10 mins)</span>
                </div>
            </div>
        </div>

        <!-- Hidden controls for navigation -->
        <div style="display: none;">
            <button id="backBtn">Back to portal</button>
        </div>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/auth-guard.js"></script>
    <script>
        // Protect page - only HR and superadmin can access
        const user = AuthGuard.protect(['hr']);
        if (!user) {
            // Page access denied, auth guard will handle redirect
            throw new Error('Access denied');
        }
        
        // Set the mock API base for backwards compatibility
        window.__MOCK_API_BASE__ = window.API_URL;
    </script>
    <script src="../js/api.js"></script>
    <script src="../js/profile.js"></script>
    <script>
        // Session-aware UI: show signed-in email if present and load user profile
        (async function(){
            const userRaw = sessionStorage.getItem('workline_user');
            const token = sessionStorage.getItem('workline_token');
            
            if (!userRaw || !token) {
                // Redirect to login if no session
                window.location.href = '../index.html';
                return;
            }

            try {
                const user = JSON.parse(userRaw);
                
                // Load user profile from backend
                const response = await fetch(`${window.API_URL}/auth/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const profile = await response.json();
                    updateUserInterface(profile);
                } else {
                    // Fallback to session data if API fails
                    updateUserInterface(user);
                }
            } catch(e) {
                console.error('Error loading user profile:', e);
                // Fallback to basic display
                document.getElementById('userName').textContent = 'User';
                document.getElementById('userRole').textContent = 'Dashboard';
            }

            // Update current date
            updateCurrentDate();
            
            // Check system status
            checkSystemStatus();

            // Event handlers
            document.getElementById('backBtn').addEventListener('click', function(){ 
                window.location.href = '../index.html'; 
            });
            
            document.getElementById('logoutBtn').addEventListener('click', function(){ 
                AuthGuard.logout();
            });

            // Profile button handler
            document.getElementById('profileBtn').addEventListener('click', function() {
                const user = ProfileModal.getCurrentUser();
                ProfileModal.open('hr', user);
            });
        })();

        function updateUserInterface(profile) {
            // Update greeting based on time of day
            const hour = new Date().getHours();
            let greeting = 'Good evening';
            if (hour < 12) greeting = 'Good morning';
            else if (hour < 18) greeting = 'Good afternoon';
            
            // Update greeting and role
            const fullName = profile.first_name && profile.last_name ? 
                `${profile.first_name} ${profile.last_name}` : 
                profile.full_name || profile.username || 'User';
            
            document.getElementById('userName').textContent = fullName;
            
            // Map role to display text
            const roleMap = {
                'hr': 'HR Admin Panel',
                'superadmin': 'Super Admin Panel',
                'head_dept': 'Department Head Panel',
                'employee': 'Employee Panel'
            };
            
            const roleDisplay = roleMap[profile.role] || 'Admin Panel';
            document.getElementById('userRole').textContent = roleDisplay;
            
            // Update the greeting text
            document.querySelector('.greeting').innerHTML = `${greeting},<br><strong id="userName">${fullName}</strong>`;
            
            // Update detailed role
            const detailedRoleMap = {
                'hr': 'HR Administrator',
                'superadmin': 'System Administrator',
                'head_dept': 'Department Head',
                'employee': 'Employee'
            };
            
            const detailedRole = detailedRoleMap[profile.role] || 'Administrator';
            document.getElementById('userRoleDetail').textContent = detailedRole;
            
            // Update scope based on role
            const scopeMap = {
                'hr': 'College-wide',
                'superadmin': 'System-wide',
                'head_dept': profile.department || 'Department-wide',
                'employee': 'Personal'
            };
            
            const scope = scopeMap[profile.role] || 'Limited';
            document.getElementById('userScope').textContent = scope;
        }

        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: '2-digit' 
            };
            const dateString = now.toLocaleDateString('en-US', options);
            document.getElementById('currentDate').textContent = dateString;
        }

        async function checkSystemStatus() {
            try {
                const response = await fetch(`${window.API_URL.replace('/api', '')}/health`);
                if (response.ok) {
                    document.getElementById('systemStatus').textContent = 'System online';
                } else {
                    document.getElementById('systemStatus').textContent = 'System issues';
                }
            } catch (e) {
                document.getElementById('systemStatus').textContent = 'Connection error';
            }
        }
    </script>

    <!-- Invitation Management Modal -->
    <div class="modal-backdrop" id="inviteModal" style="display: none;">
        <div class="modal-center">
            <div class="modal-card">
                <div class="modal-header">
                    <h3 class="modal-title">Invite New Employee</h3>
                    <button class="modal-close-btn" onclick="window.hrInvitations.closeCreateModal()">&times;</button>
                </div>
                <form id="inviteForm" class="modal-body">
                    <div class="form-group">
                        <label for="inviteEmail">Email Address *</label>
                        <input type="email" id="inviteEmail" name="email" required 
                               placeholder="employee@company.com">
                    </div>

                    <div class="form-group">
                        <label for="inviteRole">Role *</label>
                        <select id="inviteRole" name="role_id" required onchange="window.hrInvitations.handleRoleChange()">
                            <option value="">Select a role</option>
                            <!-- Will be populated with Employee and Department Head only -->
                        </select>
                    </div>

                    <div class="form-group" id="positionGroup" style="display: none;">
                        <label for="invitePosition">Position *</label>
                        <input type="text" id="invitePosition" name="position" 
                               placeholder="e.g., Software Developer, Analyst">
                    </div>

                    <div class="form-group" id="departmentGroup">
                        <label for="inviteDepartment">Department *</label>
                        <select id="inviteDepartment" name="dept_id" required>
                            <option value="">Select department</option>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="inviteExpiry">Invitation Expires In</label>
                        <select id="inviteExpiry" name="expires_in_hours">
                            <option value="24">24 hours (default)</option>
                            <option value="48">48 hours</option>
                            <option value="72">72 hours</option>
                            <option value="168">1 week</option>
                        </select>
                    </div>

                    <div id="inviteError" class="modal-message error" style="display: none;"></div>
                    <div id="inviteSuccess" class="modal-message success" style="display: none;"></div>
                </form>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="window.hrInvitations.closeCreateModal()">
                        Cancel
                    </button>
                    <button type="submit" form="inviteForm" class="modal-send-btn" id="sendInviteBtn">
                        Send Invitation
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invitation Management JavaScript -->
    <script>
        class HRInvitations {
            constructor() {
                this.invitations = [];
                this.filteredInvitations = [];
                this.roles = [];
                this.departments = [];
                
                this.elements = {
                    modal: document.getElementById('inviteModal'),
                    form: document.getElementById('inviteForm'),
                    table: document.getElementById('invitationsTable'),
                    tableBody: document.getElementById('invitationsTableBody'),
                    emptyState: document.getElementById('invitationsEmptyState'),
                    roleFilter: document.getElementById('roleFilter'),
                    departmentFilter: document.getElementById('departmentFilter'),
                    inviteError: document.getElementById('inviteError'),
                    inviteSuccess: document.getElementById('inviteSuccess'),
                    sendBtn: document.getElementById('sendInviteBtn')
                };
                
                this.init();
            }

            async init() {
                await this.loadRolesAndDepartments();
                this.setupFormHandler();
            }

            async loadRolesAndDepartments() {
                try {
                    // Load roles
                    const rolesResponse = await window.AppApi.apiFetch('/roles');
                    this.roles = rolesResponse;
                    this.populateRoleSelectors();

                    // Load departments  
                    const deptsResponse = await window.AppApi.apiFetch('/departments');
                    this.departments = deptsResponse;
                    this.populateDepartmentSelectors();
                    
                } catch (error) {
                    console.error('Error loading roles/departments:', error);
                }
            }

            populateRoleSelectors() {
                const roleSelect = document.getElementById('inviteRole');
                const filterSelect = this.elements.roleFilter;
                
                // Clear existing options (keep placeholder)
                roleSelect.innerHTML = '<option value="">Select a role</option>';
                
                // HR can only invite Employee and Department Head roles
                const allowedRoles = this.roles.filter(role => 
                    role.role_name.toLowerCase() === 'employee' || 
                    role.role_name.toLowerCase() === 'head_dept'
                );
                
                allowedRoles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.role_id;
                    // Display friendly name for head_dept
                    const displayName = role.role_name.toLowerCase() === 'head_dept' ? 'Department Head' : role.role_name;
                    option.textContent = displayName;
                    roleSelect.appendChild(option);
                });
            }

            populateDepartmentSelectors() {
                const deptSelect = document.getElementById('inviteDepartment');
                const filterSelect = this.elements.departmentFilter;
                
                // Clear existing options
                deptSelect.innerHTML = '<option value="">Select department</option>';
                filterSelect.innerHTML = '<option value="">All Departments</option>';
                
                this.departments.forEach(dept => {
                    // Invitation form
                    const option = document.createElement('option');
                    option.value = dept.dept_id;
                    option.textContent = dept.dept_name;
                    deptSelect.appendChild(option);
                    
                    // Filter
                    const filterOption = document.createElement('option');
                    filterOption.value = dept.dept_name.toLowerCase();
                    filterOption.textContent = dept.dept_name;
                    filterSelect.appendChild(filterOption);
                });
            }

            handleRoleChange() {
                const roleSelect = document.getElementById('inviteRole');
                const positionGroup = document.getElementById('positionGroup');
                const positionInput = document.getElementById('invitePosition');
                const selectedRole = roleSelect.options[roleSelect.selectedIndex];
                
                if (selectedRole && selectedRole.textContent.toLowerCase() === 'employee') {
                    // Show position field for employees
                    positionGroup.style.display = 'block';
                    positionInput.required = true;
                } else if (selectedRole && selectedRole.textContent.toLowerCase() === 'department head') {
                    // Auto-fill position for department heads
                    positionGroup.style.display = 'block';
                    positionInput.value = 'Department Head';
                    positionInput.required = true;
                    positionInput.readOnly = true;
                } else {
                    // Hide position field
                    positionGroup.style.display = 'none';
                    positionInput.required = false;
                    positionInput.readOnly = false;
                    positionInput.value = '';
                }
            }

            openCreateModal() {
                this.elements.modal.style.display = 'block';
                this.clearForm();
                this.hideMessages();
            }

            closeCreateModal() {
                this.elements.modal.style.display = 'none';
                this.clearForm();
            }

            clearForm() {
                this.elements.form.reset();
                this.hideMessages();
            }

            setupFormHandler() {
                this.elements.form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleCreateInvitation();
                });
            }

            async handleCreateInvitation() {
                const formData = new FormData(this.elements.form);
                const roleSelect = document.getElementById('inviteRole');
                const selectedRole = roleSelect.options[roleSelect.selectedIndex];
                
                // Validation
                if (!formData.get('dept_id')) {
                    this.showError('Department is required');
                    return;
                }
                
                if (selectedRole && selectedRole.textContent.toLowerCase() === 'employee') {
                    if (!formData.get('position') || !formData.get('position').trim()) {
                        this.showError('Position is required for employees');
                        return;
                    }
                }
                
                const data = {
                    email: formData.get('email').trim().toLowerCase(),
                    role_id: parseInt(formData.get('role_id')),
                    dept_id: parseInt(formData.get('dept_id')),
                    expires_in_hours: parseInt(formData.get('expires_in_hours')),
                    position: formData.get('position') ? formData.get('position').trim() : null
                };

                this.elements.sendBtn.disabled = true;
                this.elements.sendBtn.textContent = 'Sending...';
                this.hideMessages();

                try {
                    const response = await window.AppApi.apiFetch('/admin/invitations', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });

                    this.showSuccess('Invitation sent successfully!');
                    setTimeout(() => {
                        this.closeCreateModal();
                        this.refreshInvitations();
                    }, 1500);

                } catch (error) {
                    this.showError(error.message || 'Failed to send invitation');
                } finally {
                    this.elements.sendBtn.disabled = false;
                    this.elements.sendBtn.textContent = 'Send Invitation';
                }
            }

            async refreshInvitations() {
                try {
                    const response = await window.AppApi.apiFetch('/admin/invitations');
                    this.invitations = response.invitations || [];
                    this.applyFilters();
                } catch (error) {
                    console.error('Error loading invitations:', error);
                    this.showTableError('Failed to load invitations');
                }
            }

            applyFilters() {
                const roleFilter = this.elements.roleFilter.value.toLowerCase();
                const deptFilter = this.elements.departmentFilter.value.toLowerCase();

                this.filteredInvitations = this.invitations.filter(invite => {
                    const roleMatch = !roleFilter || invite.role_name.toLowerCase() === roleFilter;
                    const deptMatch = !deptFilter || (invite.dept_name && invite.dept_name.toLowerCase() === deptFilter);
                    return roleMatch && deptMatch;
                });

                this.renderInvitationsTable();
            }

            renderInvitationsTable() {
                if (this.filteredInvitations.length === 0) {
                    this.elements.table.style.display = 'none';
                    this.elements.emptyState.style.display = 'block';
                    return;
                }

                this.elements.table.style.display = 'table';
                this.elements.emptyState.style.display = 'none';

                const tbody = this.elements.tableBody;
                tbody.innerHTML = '';

                this.filteredInvitations.forEach(invite => {
                    const row = document.createElement('tr');
                    
                    const createdDate = new Date(invite.created_at).toLocaleDateString();
                    const expiresDate = new Date(invite.expires_at).toLocaleString();
                    
                    row.innerHTML = `
                        <td>${invite.email}</td>
                        <td><span class="role-badge role-${invite.role_name.toLowerCase().replace(/\s+/g, '-')}">${invite.role_name}</span></td>
                        <td>${invite.dept_name || 'N/A'}</td>
                        <td>${createdDate}</td>
                        <td>${expiresDate}</td>
                        <td>${invite.created_by || 'System'}</td>
                        <td class="actions-cell">
                            <button class="btn-icon btn-small" onclick="window.hrInvitations.resendInvitation('${invite.id}')" 
                                    title="Resend invitation">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                                    <path d="M21 3v5h-5"></path>
                                    <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                                    <path d="M3 21v-5h5"></path>
                                </svg>
                            </button>
                            <button class="btn-icon btn-small btn-danger" onclick="window.hrInvitations.cancelInvitation('${invite.id}')"
                                    title="Cancel invitation">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 6L6 18"></path>
                                    <path d="M6 6l12 12"></path>
                                </svg>
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }

            async resendInvitation(invitationId) {
                if (!confirm('Are you sure you want to resend this invitation?')) return;

                try {
                    await window.AppApi.apiFetch(`/admin/invitations/${invitationId}/resend`, {
                        method: 'POST',
                        body: JSON.stringify({ expires_in_hours: 24 })
                    });

                    this.showToast('Invitation resent successfully', 'success');
                    this.refreshInvitations();
                } catch (error) {
                    this.showToast(error.message || 'Failed to resend invitation', 'error');
                }
            }

            async cancelInvitation(invitationId) {
                if (!confirm('Are you sure you want to cancel this invitation? This cannot be undone.')) return;

                try {
                    await window.AppApi.apiFetch(`/admin/invitations/${invitationId}`, {
                        method: 'DELETE'
                    });

                    this.showToast('Invitation cancelled successfully', 'success');
                    this.refreshInvitations();
                } catch (error) {
                    this.showToast(error.message || 'Failed to cancel invitation', 'error');
                }
            }

            showError(message) {
                this.elements.inviteError.textContent = message;
                this.elements.inviteError.style.display = 'block';
                this.elements.inviteSuccess.style.display = 'none';
            }

            showSuccess(message) {
                this.elements.inviteSuccess.textContent = message;
                this.elements.inviteSuccess.style.display = 'block';
                this.elements.inviteError.style.display = 'none';
            }

            hideMessages() {
                this.elements.inviteError.style.display = 'none';
                this.elements.inviteSuccess.style.display = 'none';
            }

            showTableError(message) {
                this.elements.tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="error-row">
                            <svg width="16" height="16" style="margin-right: 6px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="15" y1="9" x2="9" y2="15"></line>
                                <line x1="9" y1="9" x2="15" y2="15"></line>
                            </svg>
                            ${message}
                        </td>
                    </tr>
                `;
            }

            showToast(message, type = 'info') {
                // Simple toast notification
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
                    color: white;
                    border-radius: 6px;
                    z-index: 10000;
                    font-weight: 500;
                `;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

            // Method to load invitations when tab becomes active
            async loadInvitations() {
                await this.refreshInvitations();
            }
        }

        // Initialize HR Invitations when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.hrInvitations = new HRInvitations();
        });
    </script>
    
    <!-- fallback no longer needed; API base is set above to local -->
    <script src="../js/HR.js"></script>
</body>
</html>
